name: Pull Request Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'pages/**'
      - '.github/workflows/**'

jobs:
  # Quick checks that should pass before allowing merge
  pr-validation:
    name: PR Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout PR
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for better diff analysis
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: pages/package-lock.json
        
    - name: Install dependencies
      run: |
        cd pages
        npm ci
        
    - name: Check for package vulnerabilities
      run: |
        cd pages
        npm audit --audit-level=moderate || true
        
    - name: Lint changed files
      run: |
        cd pages
        # Get list of changed JS/JSX files
        git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.(js|jsx)$' | grep '^pages/' | sed 's|^pages/||' | xargs -r npx eslint --max-warnings 5
        
    - name: Run tests for changed files
      run: |
        cd pages
        # Run tests related to changed files
        npm test -- --findRelatedTests --passWithNoTests --watchAll=false
        
    - name: Check bundle size impact
      run: |
        cd pages
        # Build and check size
        npm run build
        echo "### Bundle Size Report" >> $GITHUB_STEP_SUMMARY
        echo "| File | Size |" >> $GITHUB_STEP_SUMMARY
        echo "|------|------|" >> $GITHUB_STEP_SUMMARY
        find build/static -name "*.js" -o -name "*.css" | while read file; do
          size=$(du -h "$file" | cut -f1)
          name=$(basename "$file")
          echo "| $name | $size |" >> $GITHUB_STEP_SUMMARY
        done

  # Label PR based on changes
  label-pr:
    name: Auto Label PR
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      
    steps:
    - uses: actions/labeler@v4
      with:
        repo-token: "${{ secrets.GITHUB_TOKEN }}"
        
  # Comment test results on PR
  test-reporter:
    name: Test Results Comment
    runs-on: ubuntu-latest
    needs: pr-validation
    if: always()
    permissions:
      checks: write
      pull-requests: write
      
    steps:
    - name: Comment PR
      uses: actions/github-script@v7
      with:
        script: |
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });
          
          const botComment = comments.find(comment => 
            comment.user.type === 'Bot' && 
            comment.body.includes('## PR Check Results')
          );
          
          const body = `## PR Check Results
          
          âœ… All checks passed!
          
          - ğŸ§ª Tests: Passed
          - ğŸ” Linting: Passed
          - ğŸ“¦ Build: Successful
          - ğŸ”’ Security: No vulnerabilities found
          
          Ready for review! ğŸš€`;
          
          if (botComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: body
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
          }
